<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Trusted Reliable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入二维码生成库 (使用备用CDN) -->
    <script src="https://unpkg.com/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        neutral: '#6B7280',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .category-active {
                border-bottom: 3px solid theme('colors.primary');
                color: theme('colors.primary');
                font-weight: 600;
            }
            /* 按钮悬停效果 */
            .btn-hover {
                transition: all 0.2s;
                transform: scale(1);
            }
            .btn-hover:hover {
                transform: scale(1.1);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 导航栏 -->
    <header class="fixed top-0 left-0 right-0 bg-white shadow-sm z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-shopping-bag text-primary text-xl"></i>
                <h1 class="text-lg font-bold text-gray-800">STR</h1>
            </div>
            <div class="flex items-center items-center space-x-4">
                <!-- 二维码按钮 -->
                <button id="qrcode-btn" class="relative text-gray-600 hover:text-primary p-2 btn-hover" aria-label="查看二维码">
                    <i class="fa fa-qrcode text-lg"></i>
                </button>
                <!-- 搜索按钮 -->
                <button id="search-btn" class="relative text-gray-600 hover:text-primary p-2 btn-hover" aria-label="搜索商品">
                    <i class="fa fa-search text-lg"></i>
                </button>
                <!-- 购物车按钮 -->
                <button id="cart-btn" class="relative relative text-gray-600 hover:text-primary p-2 btn-hover" aria-label="查看购物车">
                    <i class="fa fa-shopping-cart text-lg"></i>
                    <span class="absolute -top-2 -right-2 bg-accent text-white text-xs rounded-full h-5 w-5 flex items-center justify-center" id="cart-count">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 搜索框 (默认隐藏) -->
    <div id="search-container" class="fixed top-16 left-0 right-0 bg-white px-4 py-3 shadow-md z-40 hidden">
        <div class="relative">
            <input type="text" id="search-input" placeholder="搜索商品..." 
                class="w-full py-2 px-10 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/50">
            <i class="fa fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <button id="close-search" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-20">
        <!-- 分类滚动栏 -->
        <div class="mb-6 overflow-x-auto scrollbar-hide">
            <div class="flex space-x-6 pb-2 min-w-max">
                <button class="category-item category-active py-2 whitespace-nowrap" data-category="all">全部商品</button>
                <button class="category-item py-2 whitespace-nowrap" data-category="house">Households 家居</button>
                <button class="category-item py-2 whitespace-nowrap" data-category="food">Food & Snacks 食品</button>
                <button class="category-item py-2 whitespace-nowrap" data-category="access">Accessory 配饰</button>
            </div>
        </div>

        <!-- 商品列表 -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="product-grid">
            <!-- 商品将通过JavaScript动态加载 -->
        </div>
    </main>

    <!-- 商品详情模态框 -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all">
            <div class="relative">
                <img id="modal-product-image" src="" alt="商品图片" class="w-full h-64 object-cover">
                <button id="close-modal" class="absolute top-4 right-4 bg-white bg-opacity-80 rounded-full p-2 shadow-md btn-hover">
                    <i class="fa fa-times text-gray-700"></i>
                </button>
            </div>
            <div class="p-6">
                <h2 id="modal-product-name" class="text-xl font-bold text-gray-800 mb-2"></h2>
                <p id="modal-product-category" class="text-sm text-neutral mb-4"></p>
                <div class="flex justify-between items-center mb-4">
                    <span id="modal-product-price" class="text-2xl font-bold text-primary"></span>
                    <div class="flex items-center">
                        <i class="fa fa-star text-accent"></i>
                        <span id="modal-product-rating" class="ml-1 text-gray-600"></span>
                    </div>
                </div>
                <p id="modal-product-description" class="text-gray-600 mb-6"></p>
                
                <div class="flex items-center justify-between border-t border-gray-100 pt-4">
                    <div class="flex items-center border rounded-full">
                        <button id="decrease-quantity" class="px-3 py-1 text-gray-600 hover:text-primary transition-colors">
                            <i class="fa fa-minus"></i>
                        </button>
                        <span id="quantity" class="px-3 py-1 min-w-[2rem] text-center">1</span>
                        <button id="increase-quantity" class="px-3 py-1 text-gray-600 hover:text-primary transition-colors">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <button id="add-to-cart" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full font-medium transition-all transform hover:scale-105">
                        <i class="fa fa-shopping-cart mr-2"></i>加入购物车
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 二维码模态框 -->
    <div id="qrcode-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full text-center transform transition-all scale-95 opacity-0" id="qrcode-modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">小程序入口二维码</h3>
            <div class="flex justify-center mb-4">
                <div id="qrcode-container" class="p-4 bg-white rounded shadow-lg">
                    <!-- 加载状态 -->
                    <div id="qrcode-loading" class="flex flex-col items-center justify-center h-50 w-50">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div>
                        <p class="text-gray-500 text-sm">正在生成二维码...</p>
                    </div>
                    <!-- 二维码将在这里生成 -->
                </div>
            </div>
            <p id="qrcode-message" class="text-gray-600 mb-6">扫描上方二维码，进入便捷购物小程序</p>
            <button id="download-qrcode" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-full font-medium transition-all" disabled>
                <i class="fa fa-download mr-2"></i>保存二维码
            </button>
            <button id="retry-qrcode" class="mt-3 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm transition-all hidden">
                <i class="fa fa-refresh mr-1"></i>重试生成
            </button>
        </div>
    </div>

    <!-- 购物车模态框 -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0" id="cart-modal-content">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800">我的购物车</h3>
                    <button id="close-cart" class="text-gray-500 hover:text-gray-700 p-2 btn-hover">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="cart-items" class="p-6">
                <!-- 购物车为空时显示 -->
                <div id="empty-cart" class="text-center py-12">
                    <i class="fa fa-shopping-cart text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">购物车还是空的</p>
                    <p class="text-gray-400 text-sm mt-2">快去添加商品吧~</p>
                </div>
                <!-- 购物车商品列表将动态生成 -->
            </div>
            <div class="p-6 border-t hidden" id="cart-summary">
                <div class="flex justify-between mb-4">
                    <span class="text-gray-600">合计:</span>
                    <span class="text-xl font-bold text-primary" id="cart-total">¥0.00</span>
                </div>
                <button id="checkout" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-full font-medium transition-all">
                    结算
                </button>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <!-- <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-40">
        <div class="flex justify-around py-3">
            <a href="#" class="flex flex-col items-center text-primary">
                <i class="fa fa-home text-xl mb-1"></i>
                <span class="text-xs">首页</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 hover:text-primary transition-colors">
                <i class="fa fa-th-large text-xl mb-1"></i>
                <span class="text-xs">分类</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 hover:text-primary transition-colors">
                <i class="fa fa-shopping-cart text-xl mb-1"></i>
                <span class="text-xs">购物车</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500 hover:text-primary transition-colors">
                <i class="fa fa-user text-xl mb-1"></i>
                <span class="text-xs">我的</span>
            </a>
        </div>
    </footer> -->

    <script>
        // 商品数据
        const products = [
            {
                id: 1,
                name: "Handbag 手拎包",
                category: "access",
                categoryName: "Accessory 配饰",
                price: 2888,
                image: "bag1.jpg",
                description: "STR Handbag combines stylish design with smart details. Its classic black and white color, plus the bold STR logo, makes it stand out. Made of high-quality leather, it looks and feels luxurious. The simple shape fits any occasion—perfect for daily outings or trendy commutes. Carry it your way and show your unique style!  ",
                rating: 4.9
            },
            {
                id: 2,
                name: "Bedding Set 床上四件套",
                category: "house",
                categoryName: "Households 家居",
                price: 668,
                image: "bed.jpg",
                description: "STR Bedding Set brings you comfort and style together. Made of high-quality cotton, it’s as soft as clouds for the best sleep ever. The simple, elegant design features a bold STR print, adding a unique touch. Perfect for cozy bedrooms or guest rooms—it upgrades any space. Fall asleep in comfort and wake up refreshed every night!  ",
                rating: 4.7
            },
            {
                id: 3,
                name: "Chips 薯片",
                category: "food",
                categoryName: "Food and Snacks 食品",
                price: 15,
                image: "chips.jpg",
                description: "STR Crispy Original - Cut BBQ - Flavored Potato Chips. Selected ingredients and original - cutting process lock in the natural potato aroma. Unique BBQ flavor, each chip is crispy and satisfying. The vibrant orange packaging allows you to start a delicious new experience anytime, anywhere. A dual enjoyment for the taste buds and vision. Fall in love with it in one bite!",
                rating: 4.7
            },
            {
                id: 4,
                name: "Chololates 巧克力",
                category: "food",
                categoryName: "Food and Snacks 食品",
                price: 68,
                image: "chocolate.jpg",
                description: "STR Pure Dark Chocolate, with a scientific extraction process, concentrates high - quality cocoa essence. The 100g exquisite packaging combines golden cloud patterns with modern design, initiating a futuristic encounter for the taste buds and vision. Every bite is a rich and smooth feast of technological flavor.",
                rating: 4.7
            },
            {
                id: 5,
                name: "Hat 鸭舌帽",
                category: "access",
                categoryName: "Accessory 配饰",
                price: 128,
                image: "hat.jpg",
                description: "STR Hat – where fashion meets personality! Available in vibrant colors，from classic black to energetic yellow, each style adds a cool touch to your look. The bold STR logo boosts your streetwear vibe instantly. Perfect for daily wear, sports, or travel—it shades you from the sun while showing off your unique style.  ",
                rating: 4.6
            },
            {
                id: 6,
                name: "Macaroon 马卡龙",
                category: "food",
                categoryName: "Food and Snacks 食品",
                price: 89,
                image: "macaroon.jpg",
                description: "For STR Macarons, we use cutting-edge ingredient proportioning algorithms to precisely control the fusion degree of protein and sugar, giving each macaron shell a perfect, crispy and airy texture. The exclusive intelligent temperature-control technology for low-temperature baking locks in the smooth and dense texture of the filling. Every bite is like experiencing a concerto where technology and deliciousness intertwine. Packaged in an exquisite transparent gift box with a built-in moisture-sensing chip, it always preserves the excellent flavor of the macarons, allowing you to encounter French sweetness anytime and anywhere. Don’t hesitate. Come and bring this technological delicacy home!",
                rating: 4.6
            },
            {
                id: 7,
                name: "Necklace 项链",
                category: "access",
                categoryName: "Accessory 配饰",
                price: 888,
                image: "necklace.jpg",
                description: "STR Necklace shines with dazzling diamonds for a stylish look. Its unique letter design is fully covered in gems. The high-quality silver chain matches any outfit. Whether for everyday wear or special moments, its sparkle will make you stand out. Wear it and shine bright with confidence!  ",
                rating: 4.6
            },
            {
                id: 8,
                name: "Nuts 坚果",
                category: "food",
                categoryName: "Food and Snacks 食品",
                price: 30,
                image: "nuts.jpg",
                description: "STR Nuts, carefully select high-quality nut raw materials and use intelligent sorting technology to accurately screen plump kernels. The transparent packaging is matched with an exquisite red bow, combining a sense of technology and a sense of ritual. Each bag contains 11 layers of nutritional codes, opening up a convenient and healthy new nut - tasting experience for you. Hurry up and buy online to unlock the intelligent deliciousness on your taste buds.",
                rating: 4.6
            },
            {
                id: 9,
                name: "Sofa 沙发",
                category: "house",
                categoryName: "Households 家居",
                price: 6888,
                image: "sofa.jpg",
                description: "STR Sofa combines simple design with premium style. Its light gray color fits any space, while the plush shape offers comfort and a modern look. The bold STR logo shows your unique taste—perfect for cozy living rooms or stylish workspaces. With its sleek elegance, it becomes the center of attention. Sit back, relax, and enjoy the vibe!  ",
                rating: 4.7
            },
            {
                id: 10,
                name: "Sunglasses 太阳镜",
                category: "access",
                categoryName: "Accessory 配饰",
                price: 1999,
                image: "sunglasses.jpg",
                description: "The STR sunglasses feature eye-catching yellow frames paired with tech - inspired dark gray lenses. The frames are made of lightweight aerospace - grade materials, and the STR logo is like a code of the future. With intelligent UV blocking technology, they accurately filter out harmful rays, creating a “tech shield” for your eyes. They excel in both fashion and function, easily nailing the trendy travel style.",
                rating: 4.8
            },
            {
                id: 11,
                name: "Tissue Box 纸巾盒",
                category: "house",
                categoryName: "Households 家居",
                price: 38,
                image: "tissue_box.jpg",
                description: "The STR tissue box reshapes daily life with technological aesthetics. Made of aviation - grade lightweight alloy material, its fresh blue appearance is created through a nano - spray coating process, with the STR logo etched on it like a future symbol. Equipped with an intelligent magnetic suction opening system, it opens with a light touch and is precisely suitable for various tissue specifications, making even the small matter of pulling tissues a footnote to the sense of home technology.",
                rating: 4.5
            },
            {
                id: 12,
                name: "Tiolet Paper 厕纸",
                category: "house",
                categoryName: "Households 家居",
                price: 48,
                image: "tissue.jpg",
                description: "STR Toilet Paper，uses advanced paper technology. Its nano-fiber design is super strong and won’t tear when wet. The STR logo on the roll stands for top quality and modern tech. With 4 layers + 3D patterns, it’s soft, gentle, and cleans well. Perfect for home or travel—upgrade your cleaning today!  ",
                rating: 4.5
            }
            
        ];

        // 购物车数据
        let cart = [];

        // DOM元素
        const productGrid = document.getElementById('product-grid');
        const categoryItems = document.querySelectorAll('.category-item');
        const productModal = document.getElementById('product-modal');
        const closeModal = document.getElementById('close-modal');
        const modalProductImage = document.getElementById('modal-product-image');
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductCategory = document.getElementById('modal-product-category');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalProductDescription = document.getElementById('modal-product-description');
        const modalProductRating = document.getElementById('modal-product-rating');
        const decreaseQuantity = document.getElementById('decrease-quantity');
        const increaseQuantity = document.getElementById('increase-quantity');
        const quantity = document.getElementById('quantity');
        const addToCartBtn = document.getElementById('add-to-cart');
        const navbar = document.getElementById('navbar');
        const qrcodeBtn = document.getElementById('qrcode-btn');
        const qrcodeModal = document.getElementById('qrcode-modal');
        const qrcodeModalContent = document.getElementById('qrcode-modal-content');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const qrcodeLoading = document.getElementById('qrcode-loading');
        const qrcodeMessage = document.getElementById('qrcode-message');
        const downloadQrcode = document.getElementById('download-qrcode');
        const retryQrcode = document.getElementById('retry-qrcode');
        const searchBtn = document.getElementById('search-btn');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        const closeSearch = document.getElementById('close-search');
        const cartBtn = document.getElementById('cart-btn');
        const cartModal = document.getElementById('cart-modal');
        const cartModalContent = document.getElementById('cart-modal-content');
        const closeCart = document.getElementById('close-cart');
        const cartItems = document.getElementById('cart-items');
        const emptyCart = document.getElementById('empty-cart');
        const cartSummary = document.getElementById('cart-summary');
        const cartTotal = document.getElementById('cart-total');
        const cartCount = document.getElementById('cart-count');
        const checkoutBtn = document.getElementById('checkout');

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts('all');
            // 预加载二维码生成函数，但不显示
            preloadQrcode();
            
            // 为所有交互元素绑定事件
            bindEvents();
        });

        // 绑定所有事件处理程序
        function bindEvents() {
            // 二维码相关事件
            qrcodeBtn.addEventListener('click', () => {
                qrcodeModal.classList.remove('hidden');
                setTimeout(() => {
                    qrcodeModalContent.classList.remove('scale-95', 'opacity-0');
                    qrcodeModalContent.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-300');
                }, 10);
                document.body.style.overflow = 'hidden';
                // 显示模态框时生成二维码
                generateQrcode();
            });

            retryQrcode.addEventListener('click', generateQrcode);

            // 其他事件绑定...
            // 分类按钮点击事件
            categoryItems.forEach(item => {
                item.addEventListener('click', () => {
                    categoryItems.forEach(btn => btn.classList.remove('category-active'));
                    item.classList.add('category-active');
                    const category = item.getAttribute('data-category');
                    renderProducts(category);
                    productGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            // 关闭二维码模态框
            qrcodeModal.addEventListener('click', (e) => {
                if (e.target === qrcodeModal) {
                    closeQrcodeModal();
                }
            });

            // 搜索按钮点击事件
            searchBtn.addEventListener('click', () => {
                searchContainer.classList.toggle('hidden');
                if (!searchContainer.classList.contains('hidden')) {
                    searchInput.focus();
                }
            });

            // 关闭搜索框
            closeSearch.addEventListener('click', () => {
                searchContainer.classList.add('hidden');
            });

            // 搜索功能
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                if (searchTerm) {
                    const filteredProducts = products.filter(product => 
                        product.name.toLowerCase().includes(searchTerm) || 
                        product.description.toLowerCase().includes(searchTerm)
                    );
                    renderFilteredProducts(filteredProducts);
                } else {
                    // 搜索为空时显示当前选中分类的商品
                    const activeCategory = document.querySelector('.category-active').getAttribute('data-category');
                    renderProducts(activeCategory);
                }
            });

            // 购物车按钮点击事件
            cartBtn.addEventListener('click', () => {
                cartModal.classList.remove('hidden');
                setTimeout(() => {
                    cartModalContent.classList.remove('scale-95', 'opacity-0');
                    cartModalContent.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-300');
                }, 10);
                document.body.style.overflow = 'hidden';
            });

            // 关闭购物车模态框
            closeCart.addEventListener('click', closeCartModal);
            cartModal.addEventListener('click', (e) => {
                if (e.target === cartModal) {
                    closeCartModal();
                }
            });

            // 关闭商品详情模态框
            closeModal.addEventListener('click', closeProductModal);
            productModal.addEventListener('click', (e) => {
                if (e.target === productModal) {
                    closeProductModal();
                }
            });

            // 数量调整
            decreaseQuantity.addEventListener('click', () => {
                let currentQuantity = parseInt(quantity.textContent);
                if (currentQuantity > 1) {
                    quantity.textContent = currentQuantity - 1;
                }
            });

            increaseQuantity.addEventListener('click', () => {
                let currentQuantity = parseInt(quantity.textContent);
                quantity.textContent = currentQuantity + 1;
            });

            // 加入购物车
            addToCartBtn.addEventListener('click', () => {
                const productId = parseInt(modalProductName.getAttribute('data-id'));
                const product = products.find(p => p.id === productId);
                const currentQuantity = parseInt(quantity.textContent);
                
                addToCart(product, currentQuantity);
                closeProductModal();
            });

            // 下载二维码
            downloadQrcode.addEventListener('click', downloadQrcodeImage);

            // 结算按钮
            checkoutBtn.addEventListener('click', () => {
                if (cart.length > 0) {
                    alert('跳转到结算页面...');
                    closeCartModal();
                }
            });

            // 滚动时改变导航栏样式
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    navbar.classList.add('shadow');
                    navbar.classList.remove('shadow-sm');
                } else {
                    navbar.classList.remove('shadow');
                    navbar.classList.add('shadow-sm');
                }
            });
        }

        // 预加载二维码生成库
        function preloadQrcode() {
            if (typeof QRCode === 'undefined') {
                // 如果QRCode库未加载，尝试重新加载
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
                script.onload = () => console.log('二维码库加载成功');
                script.onerror = () => console.log('二维码库加载失败，将在打开时重试');
                document.head.appendChild(script);
            }
        }

 // 生成带Logo的入口二维码
function generateQrcode() {
    // 清空容器
    qrcodeContainer.querySelector('canvas')?.remove();
    qrcodeContainer.querySelector('img')?.remove();
    qrcodeLoading.classList.remove('hidden');
    qrcodeMessage.textContent = '正在生成二维码...';
    qrcodeMessage.className = 'text-gray-600 mb-6';
    downloadQrcode.disabled = true;
    retryQrcode.classList.add('hidden');

    // 二维码内容（你的网站URL）
    const url = window.location.href || 'https://hujk4894.github.io/WYEF/';
    // 公司Logo路径（替换为你的Logo图片URL或本地路径）
    const logoUrl = "logo.jpg"; // 示例Logo，需替换

    try {
        if (typeof QRCode === 'undefined') {
            throw new Error('二维码生成库未加载');
        }

        // 创建临时Canvas用于绘制带Logo的二维码
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const qrcodeSize = 200; // 二维码尺寸
        canvas.width = qrcodeSize;
        canvas.height = qrcodeSize;

        // 第一步：生成基础二维码
        new QRCode(canvas, {
            text: url,
            width: qrcodeSize,
            height: qrcodeSize,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H // 高容错级别（30%），确保Logo不影响扫描
        });

        // 第二步：加载并绘制Logo
        const logoImg = new Image();
        logoImg.crossOrigin = "anonymous"; // 解决跨域问题
        logoImg.onload = function() {
            // Logo尺寸建议为二维码的1/5 ~ 1/4（避免过大影响扫描）
            const logoSize = qrcodeSize / 4;
            const x = (qrcodeSize - logoSize) / 2; // 居中定位
            const y = (qrcodeSize - logoSize) / 2;

            // 绘制白色背景（可选，让Logo更清晰）
            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(qrcodeSize/2, qrcodeSize/2, logoSize/2 + 5, 0, 2 * Math.PI); // 圆形背景
            ctx.fill();

            // 绘制Logo
            ctx.drawImage(logoImg, x, y, logoSize, logoSize);

            // 将带Logo的二维码添加到容器
            qrcodeContainer.appendChild(canvas);
            qrcodeLoading.classList.add('hidden');
            qrcodeMessage.textContent = '扫描上方二维码，进入便捷购物小程序';
            downloadQrcode.disabled = false;
        };

        // 处理Logo加载失败
        logoImg.onerror = function() {
            // 如果Logo加载失败，直接显示基础二维码
            qrcodeContainer.appendChild(canvas);
            qrcodeLoading.classList.add('hidden');
            qrcodeMessage.textContent = '二维码生成成功（Logo加载失败）';
            qrcodeMessage.className = 'text-amber-500 mb-6';
            downloadQrcode.disabled = false;
        };

        // 加载Logo图片
        logoImg.src = logoUrl;

    } catch (error) {
        console.error('生成二维码失败:', error);
        // 错误处理（保持原逻辑）
        setTimeout(() => {
            qrcodeLoading.classList.add('hidden');
            qrcodeMessage.textContent = '二维码生成失败，请重试';
            qrcodeMessage.className = 'text-red-500 mb-6';
            retryQrcode.classList.remove('hidden');
            
            const fallbackImg = document.createElement('img');
            fallbackImg.src = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(url)}&size=200x200`;
            fallbackImg.alt = '小程序入口二维码';
            fallbackImg.className = 'max-w-full h-auto';
            qrcodeContainer.appendChild(fallbackImg);
        }, 1000);
    }
}

        // 下载二维码图片
        function downloadQrcodeImage() {
            const canvas = qrcodeContainer.querySelector('canvas');
            const img = qrcodeContainer.querySelector('img');
            
            if (canvas) {
                // 从canvas下载
                const link = document.createElement('a');
                link.download = '购物小程序入口二维码.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else if (img) {
                // 从图片下载
                const link = document.createElement('a');
                link.download = '购物小程序入口二维码.png';
                link.href = img.src;
                link.click();
            } else {
                alert('无法获取二维码图片，请重试');
            }
        }

        // 关闭二维码模态框
        function closeQrcodeModal() {
            qrcodeModalContent.classList.remove('scale-100', 'opacity-100');
            qrcodeModalContent.classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-300');
            
            setTimeout(() => {
                qrcodeModal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // 关闭购物车模态框
        function closeCartModal() {
            cartModalContent.classList.remove('scale-100', 'opacity-100');
            cartModalContent.classList.add('scale-95', 'opacity-0', 'transition-all', 'duration-300');
            
            setTimeout(() => {
                cartModal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);
        }

        // 打开商品详情模态框
        function openProductModal(product) {
            modalProductImage.src = product.image;
            modalProductImage.alt = product.name;
            modalProductName.textContent = product.name;
            modalProductName.setAttribute('data-id', product.id);
            modalProductCategory.textContent = product.categoryName;
            modalProductPrice.textContent = `¥${product.price.toFixed(2)}`;
            modalProductDescription.textContent = product.description;
            modalProductRating.textContent = product.rating;
            quantity.textContent = '1';
            
            productModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 关闭商品详情模态框
        function closeProductModal() {
            productModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // 渲染商品列表
        function renderProducts(category) {
            productGrid.innerHTML = '';
            
            let filteredProducts = products;
            if (category !== 'all') {
                filteredProducts = products.filter(product => product.category === category);
            }
            
            renderFilteredProducts(filteredProducts);
        }

        // 渲染过滤后的商品
        function renderFilteredProducts(filteredProducts) {
            productGrid.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productGrid.innerHTML = `
                    <div class="col-span-full py-12 text-center">
                        <i class="fa fa-search text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">没有找到匹配的商品</p>
                    </div>
                `;
                return;
            }
            
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-lg overflow-hidden card-shadow hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 cursor-pointer';
                productCard.innerHTML = `
                    <div class="relative">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2 bg-white bg-opacity-80 rounded-full p-1 btn-hover">
                            <i class="fa fa-heart-o text-gray-500 hover:text-red-500 transition-colors"></i>
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="text-xs text-neutral mb-1">${product.categoryName}</div>
                        <h3 class="font-medium text-gray-800 mb-1 line-clamp-1">${product.name}</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-primary font-bold">¥${product.price.toFixed(2)}</span>
                            <div class="flex items-center text-xs">
                                <i class="fa fa-star text-accent mr-1"></i>
                                <span>${product.rating}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                productCard.addEventListener('click', () => {
                    openProductModal(product);
                });
                
                productGrid.appendChild(productCard);
            });
        }

        // 添加商品到购物车
        function addToCart(product, quantity) {
            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    ...product,
                    quantity: quantity
                });
            }
            
            updateCartDisplay();
            showToast(`已添加 ${product.name} x ${quantity} 到购物车`);
        }

        // 从购物车移除商品
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        // 更新购物车中商品数量
        function updateCartItemQuantity(productId, newQuantity) {
            if (newQuantity < 1) return;
            
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = newQuantity;
                updateCartDisplay();
            }
        }

        // 更新购物车显示
        function updateCartDisplay() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
            
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                emptyCart.classList.remove('hidden');
                cartSummary.classList.add('hidden');
                return;
            }
            
            emptyCart.classList.add('hidden');
            cartSummary.classList.remove('hidden');
            
            let total = 0;
            
            cart.forEach(item => {
                total += item.price * item.quantity;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'flex items-center py-3 border-b last:border-0';
                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded mr-3">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800 line-clamp-1">${item.name}</h4>
                        <p class="text-primary font-medium">¥${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center">
                        <button class="decrease-cart-item px-2 py-1 text-gray-600 hover:text-primary" data-id="${item.id}">
                            <i class="fa fa-minus"></i>
                        </button>
                        <span class="px-2">${item.quantity}</span>
                        <button class="increase-cart-item px-2 py-1 text-gray-600 hover:text-primary" data-id="${item.id}">
                            <i class="fa fa-plus"></i>
                        </button>
                        <button class="remove-cart-item ml-2 text-gray-400 hover:text-red-500" data-id="${item.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                cartItems.appendChild(cartItem);
            });
            
            cartTotal.textContent = `¥${total.toFixed(2)}`;
            
            document.querySelectorAll('.decrease-cart-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.getAttribute('data-id'));
                    const item = cart.find(item => item.id === productId);
                    updateCartItemQuantity(productId, item.quantity - 1);
                });
            });
            
            document.querySelectorAll('.increase-cart-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.getAttribute('data-id'));
                    const item = cart.find(item => item.id === productId);
                    updateCartItemQuantity(productId, item.quantity + 1);
                });
            });
            
            document.querySelectorAll('.remove-cart-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.getAttribute('data-id'));
                    removeFromCart(productId);
                });
            });
        }

        // 显示提示消息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg z-50 opacity-0 transition-opacity duration-300';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-90');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('opacity-90');
                toast.classList.add('opacity-0');
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
